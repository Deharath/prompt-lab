#!/bin/sh

# Emergency escape hatch - use ONLY when absolutely necessary
if [ "$SKIP_HOOKS" = "1" ]; then
  echo "ğŸš¨ EMERGENCY: Skipping all pre-commit checks!"
  echo "   Remember to fix issues immediately after this commit."
  exit 0
fi

# Exit immediately on any command failure
set -e

echo "ğŸ”’ Running stringent pre-commit checks..."

# Run lint-staged for formatting and linting
echo "ğŸ“ Checking code formatting and linting..."
npx lint-staged

# MANDATORY: Type checking (fails commit if errors found)
echo "ğŸ” Type checking (MANDATORY)..."
pnpm tsc

# MANDATORY: Run tests to ensure nothing is broken  
echo "ğŸ§ª Running tests (MANDATORY)..."
pnpm test --run

# Optional security audit check
echo "ğŸ”’ Security audit..."
pnpm audit --audit-level high --reporter=silent || echo "âš ï¸  Security issues found - consider fixing"

echo "âœ… All pre-commit checks passed! Code is error-free."
echo "ğŸ’¡ Emergency bypass: SKIP_HOOKS=1 git commit (use sparingly!)"
