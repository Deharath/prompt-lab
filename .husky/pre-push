#!/bin/sh

# Exit on any command failure
set -e

echo "ğŸš€ Running pre-push checks..."

# Get the current branch name
BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Block direct pushes to main/master
if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "master" ]; then
  echo "âŒ Direct pushes to $BRANCH are not allowed!"
  echo "Please create a feature branch and submit a PR."
  exit 1
fi

# Validate branch naming convention
if ! echo "$BRANCH" | grep -qE '^(feature|fix|chore|docs|refactor|test)\/[a-z0-9-]+$'; then
  echo "âš ï¸  Branch name '$BRANCH' doesn't follow convention:"
  echo "   Expected: {feature|fix|chore|docs|refactor|test}/{description}"
  echo "   Example: feature/user-authentication"
  echo "   Continuing anyway..."
fi

# Run full quality check
echo "ğŸ” Running full quality check..."
pnpm quality:check

# Security audit
echo "ğŸ”’ Running security audit..."
pnpm audit --audit-level high || echo "âš ï¸  Security audit found issues, please review"

echo "âœ… Pre-push checks passed!"
