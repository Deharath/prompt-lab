# .github/workflows/ci.yml
name: CI

on:
  push:
  pull_request:

jobs:
  # ───────────────────────── Check Windows Runner Availability ─────────────────────────
  check-windows:
    runs-on: [self-hosted, windows, primary]
    timeout-minutes: 2
    continue-on-error: true
    outputs:
      available: ${{ steps.check.outputs.available }}
    steps:
      - id: check
        run: |
          Write-Output "Windows runner is available"
          Write-Output "available=true" >> $env:GITHUB_OUTPUT

  # ───────────────────────── Primary Build (Windows) ─────────────────────────
  build-windows:
    needs: check-windows
    if: needs.check-windows.result == 'success'
    uses: ./.github/workflows/reusable-build-test.yml
    with:
      os: windows
      labels: '["self-hosted", "windows", "primary"]'
      node-version: '18.x'

  # ───────────────────────── Fallback Build (Linux) ─────────────────────────
  build-linux:
    needs: check-windows
    if: needs.check-windows.result != 'success'
    uses: ./.github/workflows/reusable-build-test.yml
    with:
      os: linux
      labels: '["self-hosted", "linux", "backup"]'
      node-version: '18.x'

  # ───────────────────────── Docker smoke test (Windows) ────────────────────────────
  docker-windows:
    needs: [check-windows, build-windows]
    if: needs.check-windows.result == 'success' && needs.build-windows.result == 'success'
    uses: ./.github/workflows/reusable-docker-smoke-test.yml
    with:
      os: windows
      labels: '["self-hosted", "windows", "primary"]'

  # ───────────────────────── Docker smoke test (Linux) ────────────────────────────
  docker-linux:
    needs: [check-windows, build-linux]
    if: needs.check-windows.result != 'success' && needs.build-linux.result == 'success'
    uses: ./.github/workflows/reusable-docker-smoke-test.yml
    with:
      os: linux
      labels: '["self-hosted", "linux", "backup"]'
