name: CI

on:
  push:
  pull_request:

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Build Dependencies & Packages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    runs-on: ['self-hosted', 'linux']
    steps:
      - uses: actions/checkout@v4

      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'pnpm'

      - name: Install native build tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y build-essential python3 python3-dev
          sudo apt-get install -y pkg-config libsqlite3-dev

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        env:
          npm_config_build_from_source: true
          SQLITE3_FORCE_COMPILE: true

      - name: Build all packages
        run: pnpm build

      - name: Upload built workspace
        uses: actions/upload-artifact@v4
        with:
          name: built-workspace-${{ github.sha }}
          path: .

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Lint Checks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lint:
    needs: build
    runs-on: ['self-hosted', 'linux']
    steps:
      - uses: actions/checkout@v4

      - name: Download built workspace
        uses: actions/download-artifact@v4
        with:
          name: built-workspace-${{ github.sha }}
          path: .

      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run lint checks
        run: |
          pnpm -r lint
          pnpm lint:data
          pnpm audit --audit-level moderate
          pnpm deps:check

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Unit Tests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test:
    needs: build
    runs-on: ['self-hosted', 'linux']
    steps:
      - uses: actions/checkout@v4

      - name: Download built workspace
        uses: actions/download-artifact@v4
        with:
          name: built-workspace-${{ github.sha }}
          path: .

      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests
        run: pnpm -r test

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Docker smoke test â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  docker-smoke-test:
    needs: [build, lint, test]
    runs-on: ['self-hosted', 'linux']
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - name: Clean up any existing containers
        run: |
          containers=$(docker ps -a --filter "name=promptlab" --format "{{.ID}}")
          if [ -n "$containers" ]; then
            echo "Removing existing containers: $containers"
            docker rm -f $containers
          else
            echo "No existing containers to remove"
          fi

      - name: Build image
        uses: docker/build-push-action@v5
        with:
          context: .
          tags: promptlab:test
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Start container
        run: docker run -d --name promptlab -p 3000:3000 -e OPENAI_API_KEY=dummy-key-for-ci -e NODE_ENV=test -e HOST=0.0.0.0 promptlab:test

      - name: Wait for API health check
        run: |
          echo "ðŸš€ Waiting for API to become ready..."
          echo "Container should be starting now..."

          # Give the container a moment to initialize
          sleep 5

          for i in $(seq 1 40); do
            # Check if container is still running
            container_status=$(docker ps --filter name=promptlab --format '{{.Status}}' 2>/dev/null || echo "not found")
            if [[ ! "$container_status" =~ "Up" ]]; then
              echo "âŒ Container not running (status: $container_status)"
              echo "ðŸ“‹ Container logs:"
              docker logs promptlab 2>&1 || echo "No logs available"
              exit 1
            fi
            
            # Check if API is ready
            echo "ðŸ” Checking health endpoint (attempt $i/40)..."
            if curl -sf -m 5 http://localhost:3000/health/ping >/dev/null 2>&1; then
              echo "âœ… Basic ping endpoint working! Checking ready endpoint..."
              
              # Now check the actual ready endpoint
              if curl -sf -m 5 http://localhost:3000/health/ready >/dev/null 2>&1; then
                echo "âœ… Ready endpoint working! Health check passed."
              else
                echo "âš ï¸  Ready endpoint not responding, but ping works. Checking logs..."
                echo "ðŸ“‹ Recent container logs:"
                docker logs --tail 20 promptlab 2>&1 || echo "No recent logs available"
                exit 1
              fi
              
              # Also test that we can reach the main health endpoint
              echo "ðŸ§ª Testing main health endpoint..."
              if curl -sf -m 5 http://localhost:3000/health >/dev/null 2>&1; then
                echo "âœ… Main health endpoint also working!"
              else
                echo "âš ï¸  Main health endpoint not responding, but /ready is working"
              fi
              exit 0
            fi
            
            # Show some debug info every few attempts
            if [ $((i % 5)) -eq 0 ]; then
              echo "ðŸ” Debug info at attempt $i:"
              echo "   Container status: $container_status"
              echo "   Port 3000 listening: $(netstat -tuln 2>/dev/null | grep ':3000' || echo 'not detected')"
            fi
            
            echo "â³ API not ready yet... waiting 3 seconds (attempt $i/40)"
            sleep 3
          done

          echo "âŒ Gave up waiting for API after 120 seconds"
          echo "ðŸ“‹ Final container status:"
          docker ps --filter name=promptlab --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" || echo "No container info"
          echo "ðŸ“‹ Final container logs:"
          docker logs promptlab 2>&1 || echo "No logs available"
          echo "ðŸ“‹ Network info:"
          netstat -tuln 2>/dev/null | grep ':3000' || echo "Port 3000 not listening"
          exit 1

      - name: Clean up containers
        if: always()
        run: |
          containers=$(docker ps -a --filter "name=promptlab" --format "{{.ID}}")
          if [ -n "$containers" ]; then
            echo "Cleaning up containers: $containers"
            docker rm -f $containers
          else
            echo "No containers to clean up"
          fi
